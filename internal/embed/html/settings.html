{{ template "base.html" . }}
{{ define "title" }}Settings{{ end }}
{{ define "content" }}
{{if .GithubAuthURL}}
<h3>Auth</h3>
<p>
    Click the button below to connect another GitHub account. This link will expire after 10 minutes.
</p>
<p>
    <a href="{{.GithubAuthURL}}" class="github-btn" id="assoc-uri">
        <img src="../static/github-mark-white.png" alt="GitHub" class="github-logo">
        Connect GitHub Account
    </a>
</p>
<p>
    The following GitHub accounts are currently associated with your Officetracker account:
    <ul>
        {{range .GithubAccounts}}
        <li>{{.}}</li>
        {{end}}
    </ul>
</p>
{{end}}

<h3>Themes</h3>
<p>
    Select a visual theme for Officetracker.
</p>

<div class="theme-selector">
    <div class="theme-option">
        <label for="theme-select">Select Theme:</label>
        <select id="theme-select">
            <option value="default">Default</option>
            <option value="dark">Dark</option>
            <option value="city-skyline">City Skyline</option>
        </select>
    </div>
    
    <div class="theme-option" id="weather-option" style="display: none;">
        <div class="checkbox-wrapper">
            <input type="checkbox" id="weather-enabled">
            <label for="weather-enabled">Enable weather effects</label>
        </div>
    </div>
    
    <div class="theme-option" id="time-option" style="display: none;">
        <div class="checkbox-wrapper">
            <input type="checkbox" id="time-based-enabled">
            <label for="time-based-enabled">Enable time-based background</label>
        </div>
    </div>
</div>

<h3>Schedule</h3>
<p>
    Select the days of the week you plan to attend the office on a recurring cycle.
</p>

<div id="schedule-calendar" class="schedule-container">
    <table>
        <tr>
            <td class="schedule-day" data-day="monday" data-state="0">
                <div class="day-header">Mon</div>
            </td>
            <td class="schedule-day" data-day="tuesday" data-state="0">
                <div class="day-header">Tue</div>
            </td>
            <td class="schedule-day" data-day="wednesday" data-state="0">
                <div class="day-header">Wed</div>
            </td>
            <td class="schedule-day" data-day="thursday" data-state="0">
                <div class="day-header">Thu</div>
            </td>
            <td class="schedule-day" data-day="friday" data-state="0">
                <div class="day-header">Fri</div>
            </td>
            <td class="schedule-day" data-day="saturday" data-state="0">
                <div class="day-header">Sat</div>
            </td>
            <td class="schedule-day" data-day="sunday" data-state="0">
                <div class="day-header">Sun</div>
            </td>
        </tr>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Server-provided theme preferences, if available
        const serverTheme = "{{.ThemePreferences.Theme}}";
        const serverWeatherEnabled = {{.ThemePreferences.WeatherEnabled}};
        const serverTimeBasedEnabled = {{.ThemePreferences.TimeBasedEnabled}};
        
        // Server-provided schedule preferences
        const serverSchedule = {
            monday: {{.SchedulePreferences.Monday}},
            tuesday: {{.SchedulePreferences.Tuesday}},
            wednesday: {{.SchedulePreferences.Wednesday}},
            thursday: {{.SchedulePreferences.Thursday}},
            friday: {{.SchedulePreferences.Friday}},
            saturday: {{.SchedulePreferences.Saturday}},
            sunday: {{.SchedulePreferences.Sunday}}
        };
        
        // State names mapping
        const stateNames = {
            0: "Untracked",
            1: "Work from Home", 
            2: "In office",
            3: "Other"
        };
        
        // Load current theme preferences, prioritizing server values if available
        const currentTheme = serverTheme || localStorage.getItem('officetracker-theme') || 'default';
        const weatherEnabled = (serverTheme !== "") ? serverWeatherEnabled : (localStorage.getItem('officetracker-weather-enabled') === 'true');
        const timeBasedEnabled = (serverTheme !== "") ? serverTimeBasedEnabled : (localStorage.getItem('officetracker-time-based-enabled') === 'true');
        
        // Set form values
        document.getElementById('theme-select').value = currentTheme;
        document.getElementById('weather-enabled').checked = weatherEnabled;
        document.getElementById('time-based-enabled').checked = timeBasedEnabled;
        
        // Show/hide options based on selected theme
        toggleOptions(currentTheme);
        
        // Initialize schedule calendar
        initializeScheduleCalendar();
        
        // Save settings function
        function saveSettings() {
            const theme = document.getElementById('theme-select').value;
            const weatherEnabled = document.getElementById('weather-enabled').checked;
            const timeBasedEnabled = document.getElementById('time-based-enabled').checked;
            
            // Save to localStorage
            localStorage.setItem('officetracker-theme', theme);
            localStorage.setItem('officetracker-weather-enabled', weatherEnabled);
            localStorage.setItem('officetracker-time-based-enabled', timeBasedEnabled);
            
            // Apply theme immediately
            applyTheme(theme, weatherEnabled, timeBasedEnabled);
            
            // Save to server without alerts
            fetch('/api/v1/settings/theme', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: {
                        theme: theme,
                        weather_enabled: weatherEnabled,
                        time_based_enabled: timeBasedEnabled
                    }
                }),
                credentials: "include"
            })
            .catch(error => {
                console.error('Error saving theme settings:', error);
            });
        }
        
        // Save schedule preferences function
        function saveScheduleSettings() {
            const schedule = getCurrentSchedule();
            
            fetch('/api/v1/settings/schedule', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: schedule
                }),
                credentials: "include"
            })
            .catch(error => {
                console.error('Error saving schedule settings:', error);
            });
        }
        
        // Get current schedule state from DOM
        function getCurrentSchedule() {
            const schedule = {};
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                const dayElement = document.querySelector(`[data-day="${day}"]`);
                schedule[day] = parseInt(dayElement.dataset.state);
            });
            
            return schedule;
        }
        
        // Cycle through states: Untracked -> Work from Home -> In office -> Other -> Untracked
        function cycleScheduleState(dayElement, direction = 1) {
            const currentState = parseInt(dayElement.dataset.state);
            const nextState = (currentState + direction + 4) % 4;
            
            dayElement.dataset.state = nextState;
        }
        
        // Initialize schedule calendar with server data
        function initializeScheduleCalendar() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                const dayElement = document.querySelector(`[data-day="${day}"]`);
                const state = serverSchedule[day] || 0;
                
                // Set initial state
                dayElement.dataset.state = state;
                
                // Add click event listeners
                dayElement.addEventListener('click', function() {
                    cycleScheduleState(this, 1);
                    saveScheduleSettings();
                });
                
                dayElement.addEventListener('contextmenu', function(event) {
                    event.preventDefault();
                    cycleScheduleState(this, -1);
                    saveScheduleSettings();
                });
            });
        }
        
        // Event listener for theme change
        document.getElementById('theme-select').addEventListener('change', function() {
            toggleOptions(this.value);
            saveSettings();
        });
        
        // Event listeners for checkbox changes
        document.getElementById('weather-enabled').addEventListener('change', saveSettings);
        document.getElementById('time-based-enabled').addEventListener('change', saveSettings);
    });
    
    function toggleOptions(theme) {
        const weatherOption = document.getElementById('weather-option');
        const timeOption = document.getElementById('time-option');
        
        if (theme === 'city-skyline') {
            weatherOption.style.display = 'block';
            timeOption.style.display = 'block';
        } else {
            weatherOption.style.display = 'none';
            timeOption.style.display = 'none';
        }
    }
</script>

<style>
/* Fix schedule calendar vertical alignment by removing bottom margin from day headers */
.schedule-day .day-header {
    margin-bottom: 0;
}
</style>

<div class="legend">
    <div class="legend-item">
        <div class="legend-color present"></div>
        <span>Work from Home</span>
    </div>
    <div class="legend-item">
        <div class="legend-color not-present"></div>
        <span>In office</span>
    </div>
    <div class="legend-item">
        <div class="legend-color other"></div>
        <span>Other (Untracked)</span>
    </div>
</div>


{{ end }}